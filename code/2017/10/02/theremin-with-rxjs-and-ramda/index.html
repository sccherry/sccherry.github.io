<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Theremin (with Rxjs and Ramda) | Cherry on Top</title><meta name="description" content="Theremin (with Rxjs and Ramda) October 2, 2017 Drag cursor to begin playing See..."><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="apple-touch-startup-image" href="/assets/android-chrome-192x192.png"><link rel="icon" type="image/png" href="/assets/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/assets/favicon-16x16.png" sizes="16x16"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#2b8a3e"><link rel="shortcut icon" href="/assets/favicon.ico"><meta name="apple-mobile-web-app-title" content="Cherry on Top"><meta name="theme-color" content="#2b8a3e"><meta name="application-name" content="Cherry on Top"><meta name="msapplication-TileColor" content="#2b8a3e"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="/css/main.css"><link rel="canonical" href="https://stevecherry.net/code/2017/10/02/theremin-with-rxjs-and-ramda/"><link rel="alternate" type="application/rss+xml" title="Cherry on Top" href="/feed.xml"></head><body class="font-sans text-default flex flex-col min-h-screen max-w-xl mx-auto px-3" prefix="schema: http://schema.org/"><header role="banner"><h1><a href="/" class="text-primary no-underline">Cherry on Top</a></h1></header><nav role="navigation"><ul class="flex"><li class=""><a href="/about/">About</a></li><li class="ml-3"><a href="/resume/">Résumé</a></li></ul></nav><main class="flex-1" role="main"><article><header><h2>Theremin (with Rxjs and Ramda)</h2><time datetime="2017-10-02T00:00:00.000Z">October 2, 2017</time></header><div class="longform"><p>Drag cursor to begin playing</p><p>See <a href="https://www.smashingmagazine.com/2016/06/make-music-in-the-browser-with-a-web-audio-theremin/">https://www.smashingmagazine.com/2016/06/make-music-in-the-browser-with-a-web-audio-theremin/</a></p><div data-default-tab="js,result" data-prefill="{&quot;title&quot;:&quot;Theremin (with Rxjs and Ramda)&quot;,&quot;tags&quot;:[],&quot;scripts&quot;:[&quot;https://cdnjs.cloudflare.com/ajax/libs/rxjs/5.4.3/Rx.min.js&quot;,&quot;https://cdnjs.cloudflare.com/ajax/libs/ramda/0.24.1/ramda.min.js&quot;]}"><pre data-lang="javascript"><code class="language-javascript">/**
 * Global variables
 */

const MIN_FREQUENCY = 20;
const MAX_FREQUENCY = 2000;
const MIN_GAIN = 0;
const MAX_GAIN = 1;

/**
 * Math
 */

const linearScale = R.curry(([dMin, dMax], [rMin, rMax], val) =&gt; {
  return R.add(
    R.multiply(
      R.divide(
        R.subtract(val, dMin),
        R.subtract(dMax, dMin)
      ),
      R.subtract(rMax, rMin)
    ),
    rMin
  );
});

const getClient = (propName) =&gt; R.ifElse(
  R.compose(R.not, R.isNil, R.prop(&#39;touches&#39;)),
  R.compose(R.prop(propName), R.head, R.prop(&#39;touches&#39;)),
  R.prop(propName)
);

const calculateFrequency = R.compose(
  R.clamp(MIN_FREQUENCY, MAX_FREQUENCY),
  linearScale([0, window.innerWidth], [MIN_FREQUENCY, MAX_FREQUENCY]),
  getClient(&#39;clientX&#39;)
);

const calculateGain = R.compose(
  R.clamp(MIN_GAIN, MAX_GAIN),
  linearScale([0, window.innerHeight], [MIN_GAIN, MAX_GAIN]),
  getClient(&#39;clientY&#39;)
);

const values = (e) =&gt; {
  return [
    calculateFrequency(e),
    calculateGain(e)
  ];
};

/**
 * Events
 */

const pointerdown = (target) =&gt; {
  return Rx.Observable.merge(
    Rx.Observable.fromEvent(target, &#39;mousedown&#39;),
    Rx.Observable.fromEvent(target, &#39;touchstart&#39;)
  );
};

const pointermove = (target) =&gt; {
  return Rx.Observable.merge(
    Rx.Observable.fromEvent(target, &#39;mousemove&#39;),
    Rx.Observable.fromEvent(target, &#39;touchmove&#39;)
  );
};

const pointerup = (target) =&gt; {
  return Rx.Observable.merge(
    Rx.Observable.fromEvent(target, &#39;mouseup&#39;),
    Rx.Observable.fromEvent(target, &#39;touchend&#39;)
  );
};

const pointerdrag = (target) =&gt; {
  return pointerdown(target).mergeMap(() =&gt; {
    return pointermove(target).takeUntil(pointerup(target));
  });
};

/**
 * Synth
 */

const context = new AudioContext();
const gain = context.createGain();
gain.connect(context.destination);

let osc = null;

const start = (f, g, when = 0) =&gt; {
  if (!osc) {
    osc = context.createOscillator();
    osc.connect(gain);
    osc.frequency.value = f;
    gain.gain.value = g;
    osc.start();
  }
};

const stop = () =&gt; {
  if (osc) {
    osc.stop();
    osc.disconnect();
    osc = null;
  }
};

const setTargetAtTime = (f, g, when = 0, timeConstant = 0.01) =&gt; {
  if (osc) {
    osc.frequency.setTargetAtTime(f, when, timeConstant);
  }

  gain.gain.setTargetAtTime(g, when, timeConstant);
};

/**
 * App
 */

const app = (target) =&gt; {
  pointerdown(target).map(values).subscribe(([freq, gain]) =&gt; {
    start(freq, gain);
  });

  pointerdrag(target).map(values).subscribe(([freq, gain]) =&gt; {
    setTargetAtTime(freq, gain);
  });

  pointerup(target).subscribe(() =&gt; stop());
};

app(document);</code></pre></div><button class="prefill-click-to-run bg-transparent border border-primary border-solid hover:bg-primary hover:text-white p-2 text-primary w-full">Click to Run</button><script async src="/js/prism.js"></script><script async src="https://static.codepen.io/assets/embed/ei.js"></script><script>// On click, the element will become the embed!
document.querySelector('.prefill-click-to-run').addEventListener('click', function(e) {
  document.querySelector('[data-prefill]').classList.add('codepen'); // Add the codepen class back.
  window.__CPEmbed(); // Trigger the CodePen embed script to run again.
});</script></div></article></main><footer class="border-0 border-solid border-primary border-t mb-6 pt-6" role="contentinfo"><p>The online home of Steve Cherry.</p><ul class="list-none pl-0 flex"><li><a href="/feed.xml" class="hover:text-rss focus:text-rss">Feed</a></li><li class="ml-3"><a href="mailto:stevenccherry@gmail.com">Email</a></li><li class="ml-3"><a href="https://github.com/sccherry" class="hover:text-github focus:text-github">Github</a></li><li class="ml-3"><a href="https://codepen.io/sccherry" class="hover:text-codepen focus:text-codepen">Codepen</a></li></ul></footer><script src="/js/pjax.js" defer="defer"></script><script src="/js/main.js" defer="defer"></script></body></html>