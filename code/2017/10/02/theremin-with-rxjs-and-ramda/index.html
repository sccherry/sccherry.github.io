<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Theremin (with Rxjs and Ramda) | Cherry on Top</title><meta name="description" content="Theremin (with Rxjs and Ramda) October 2, 2017 See https://www.smashingmagazine.com/2016/06/make-music-in-the-browser-with-a-web-audio-theremin/ &amp;lt;p&gt;Drag..."><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="apple-touch-startup-image" href="/assets/android-chrome-192x192.png"><link rel="icon" type="image/png" href="/assets/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="/assets/favicon-16x16.png" sizes="16x16"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#2b8a3e"><link rel="shortcut icon" href="/assets/favicon.ico"><meta name="apple-mobile-web-app-title" content="Cherry on Top"><meta name="theme-color" content="#2b8a3e"><meta name="application-name" content="Cherry on Top"><meta name="msapplication-TileColor" content="#2b8a3e"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="/css/main.css"><link rel="canonical" href="https://stevecherry.net/code/2017/10/02/theremin-with-rxjs-and-ramda/"><link rel="alternate" type="application/rss+xml" title="Cherry on Top" href="/feed.xml"></head><body class="font-sans text-default flex flex-col min-h-screen max-w-xl mx-auto px-3" prefix="schema: http://schema.org/"><header role="banner"><h1><a href="/" class="text-primary no-underline">Cherry on Top</a></h1></header><nav role="navigation"><ul class="flex"><li class=""><a href="/">Home</a></li><li class="ml-3"><a href="/about/">About</a></li><li class="ml-3"><a href="/resume/">Résumé</a></li></ul></nav><main class="flex-1" role="main"><article><header><h2>Theremin (with Rxjs and Ramda)</h2><time datetime="2017-10-02T00:00:00.000Z">October 2, 2017</time></header><div class="longform"><p>See <a href="https://www.smashingmagazine.com/2016/06/make-music-in-the-browser-with-a-web-audio-theremin/">https://www.smashingmagazine.com/2016/06/make-music-in-the-browser-with-a-web-audio-theremin/</a></p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Drag cursor to begin playing.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></code></pre><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> add<span class="token punctuation">,</span> clamp<span class="token punctuation">,</span> compose<span class="token punctuation">,</span> curry<span class="token punctuation">,</span> divide<span class="token punctuation">,</span> head<span class="token punctuation">,</span> ifElse<span class="token punctuation">,</span> isNil<span class="token punctuation">,</span> multiply<span class="token punctuation">,</span> not<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> subtract <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'https://cdn.skypack.dev/ramda@^0.27.0'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> fromEvent<span class="token punctuation">,</span> merge <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'https://cdn.skypack.dev/rxjs@^6.5.5'</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> map<span class="token punctuation">,</span> mergeMap<span class="token punctuation">,</span> takeUntil <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'https://cdn.skypack.dev/rxjs@^6.5.5/operators'</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * Global variables<br> */</span><br><br><span class="token keyword">const</span> <span class="token constant">MIN_FREQUENCY</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token constant">MAX_FREQUENCY</span> <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token constant">MIN_GAIN</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token constant">MAX_GAIN</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * Math<br> */</span><br><br><span class="token keyword">const</span> linearScale <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>dMin<span class="token punctuation">,</span> dMax<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>rMin<span class="token punctuation">,</span> rMax<span class="token punctuation">]</span><span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">add</span><span class="token punctuation">(</span><br>    <span class="token function">multiply</span><span class="token punctuation">(</span><br>      <span class="token function">divide</span><span class="token punctuation">(</span><br>        <span class="token function">subtract</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> dMin<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token function">subtract</span><span class="token punctuation">(</span>dMax<span class="token punctuation">,</span> dMin<span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token function">subtract</span><span class="token punctuation">(</span>rMax<span class="token punctuation">,</span> rMin<span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">,</span><br>    rMin<br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">getClient</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">propName</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">ifElse</span><span class="token punctuation">(</span><br>  <span class="token function">compose</span><span class="token punctuation">(</span>not<span class="token punctuation">,</span> isNil<span class="token punctuation">,</span> <span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'touches'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">prop</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">,</span> head<span class="token punctuation">,</span> <span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'touches'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">prop</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> calculateFrequency <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><br>  <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token constant">MIN_FREQUENCY</span><span class="token punctuation">,</span> <span class="token constant">MAX_FREQUENCY</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">linearScale</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token constant">MIN_FREQUENCY</span><span class="token punctuation">,</span> <span class="token constant">MAX_FREQUENCY</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">getClient</span><span class="token punctuation">(</span><span class="token string">'clientX'</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> calculateGain <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><br>  <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token constant">MIN_GAIN</span><span class="token punctuation">,</span> <span class="token constant">MAX_GAIN</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">linearScale</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token constant">MIN_GAIN</span><span class="token punctuation">,</span> <span class="token constant">MAX_GAIN</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token function">getClient</span><span class="token punctuation">(</span><span class="token string">'clientY'</span><span class="token punctuation">)</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">values</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">[</span><br>    <span class="token function">calculateFrequency</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">calculateGain</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><br>  <span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * Events<br> */</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">pointerdown</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">merge</span><span class="token punctuation">(</span><br>    <span class="token function">fromEvent</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'mousedown'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">fromEvent</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'touchstart'</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">pointermove</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">merge</span><span class="token punctuation">(</span><br>    <span class="token function">fromEvent</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'mousemove'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">fromEvent</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'touchmove'</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">pointerup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">merge</span><span class="token punctuation">(</span><br>    <span class="token function">fromEvent</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'mouseup'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token function">fromEvent</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'touchend'</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">pointerdrag</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token function">pointerdown</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><br>    <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">pointermove</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">takeUntil</span><span class="token punctuation">(</span><span class="token function">pointerup</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * Synth<br> */</span><br><br><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> gain <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createGain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>gain<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">let</span> osc <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">start</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> g<span class="token punctuation">,</span> when <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>osc<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    osc <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createOscillator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    osc<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>gain<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    osc<span class="token punctuation">.</span>frequency<span class="token punctuation">.</span>value <span class="token operator">=</span> f<span class="token punctuation">;</span><br>    gain<span class="token punctuation">.</span>gain<span class="token punctuation">.</span>value <span class="token operator">=</span> g<span class="token punctuation">;</span><br>    osc<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">stop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>osc<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    osc<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    osc<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    osc <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">setTargetAtTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> g<span class="token punctuation">,</span> when <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> timeConstant <span class="token operator">=</span> <span class="token number">0.01</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>osc<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    osc<span class="token punctuation">.</span>frequency<span class="token punctuation">.</span><span class="token function">setTargetAtTime</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> when<span class="token punctuation">,</span> timeConstant<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  gain<span class="token punctuation">.</span>gain<span class="token punctuation">.</span><span class="token function">setTargetAtTime</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> when<span class="token punctuation">,</span> timeConstant<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * App<br> */</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">app</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">pointerdown</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>freq<span class="token punctuation">,</span> gain<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">start</span><span class="token punctuation">(</span>freq<span class="token punctuation">,</span> gain<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">pointerdrag</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>freq<span class="token punctuation">,</span> gain<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">setTargetAtTime</span><span class="token punctuation">(</span>freq<span class="token punctuation">,</span> gain<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token function">pointerup</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token function">app</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><div class="h-0 overflow-hidden pt-9/16 relative border border-solid border-default"><iframe src="embed.html" class="absolute top-0 left-0 w-full h-full"></iframe></div></div></article></main><footer class="border-0 border-solid border-primary border-t mb-6 pt-6" role="contentinfo"><p>The online home of Steve Cherry.</p><ul class="list-none pl-0 flex"><li><a href="/feed.xml" class="hover:text-rss focus:text-rss">Feed</a></li><li class="ml-3"><a href="mailto:stevenccherry@gmail.com">Email</a></li><li class="ml-3"><a href="https://github.com/sccherry" class="hover:text-github focus:text-github">Github</a></li></ul></footer><script src="/js/pjax.js" defer="defer"></script><script src="/js/main.js" defer="defer"></script></body></html>