<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Frequency bar graph (with Vue, D3, and Rxjs) | Cherry on Top</title>
  <meta name="description" content="Frequency bar graph (with Vue, D3, and Rxjs) October 2, 2017 &amp;lt;div id=&amp;quot;app&amp;quot;&amp;gt; &amp;lt;p&amp;gt;Click document to start&amp;lt;/p&amp;gt; &amp;lt;bar-chart...">

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
  <link rel="apple-touch-startup-image" href="/assets/android-chrome-192x192.png">
  <link rel="icon" type="image/png" href="/assets/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/assets/favicon-16x16.png" sizes="16x16">
  <link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#2b8a3e">
  <link rel="shortcut icon" href="/assets/favicon.ico">

  <meta name="apple-mobile-web-app-title" content="Cherry on Top">
  <meta name="theme-color" content="#2b8a3e">
  <meta name="application-name" content="Cherry on Top">
  <meta name="msapplication-TileColor" content="#2b8a3e">
  <meta name="msapplication-config" content="/browserconfig.xml">
  <link rel="manifest" href="/manifest.json">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://stevecherry.net/posts/2017/10/02/spectrogram/">
  <link rel="alternate" type="application/rss+xml" title="Cherry on Top" href="/feed.xml">
</head>

<body class="font-sans text-default flex flex-col min-h-screen max-w-xl mx-auto px-3" prefix="schema: http://schema.org/">
  <header role="banner">
    <h1><a href="/" class="text-primary no-underline">Cherry on Top</a></h1>
  </header>

  <nav role="navigation">
    <ul><li><a href="/about/">About</a></li></ul>
  </nav>

  <main class="flex-1" role="main">
    
<article>
  <header>
    <h2>Frequency bar graph (with Vue, D3, and Rxjs)</h2>
    <time datetime="2017-10-02T00:00:00.000Z">October 2, 2017</time>
  </header>

  <div class="longform">
    


      <div data-default-tab="js,result" data-prefill='{"title":"Frequency bar graph (with Vue, D3, and Rxjs)","tags":[],"scripts":["https://unpkg.com/vue@2.4.4/dist/vue.min.js","https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.2/d3.min.js","https://cdnjs.cloudflare.com/ajax/libs/rxjs/5.4.3/Rx.min.js"],"stylesheets":[]}'>
        
<pre data-lang="html"><code class="language-html">&lt;div id=&quot;app&quot;&gt;
  &lt;p&gt;Click document to start&lt;/p&gt;
  &lt;bar-chart width=&quot;960&quot; height=&quot;600&quot; :data=&quot;frequencies&quot;&gt;&lt;/bar-chart&gt;
&lt;/div&gt;

&lt;template id=&quot;bar-chart&quot;&gt;
  &lt;svg :view-box.camel=&quot;viewBox&quot;&gt;
    &lt;rect v-for=&quot;bar in bars&quot; v-bind=&quot;bar&quot;&gt;&lt;/rect&gt;
  &lt;/svg&gt;
&lt;/template&gt;
</code></pre>
<pre data-lang="css"><code class="language-css">html {
  background-color: black;
}

body {
  display: flex;
  align-items: center;
  justify-content: center;
}

p {
  color: white;
  text-align: center;
}

#app {
  flex: 1;
}</code></pre>
<pre data-lang="babel"><code class="language-js">/**
 * Global variables
 */

const MIN_FREQ = 20;
const MAX_FREQ = 6000;
const NUM_BARS = 32;
const FFT_SIZE = 1024 * 8;
const CONTEXT = new AudioContext();

/**
 * Utility functions
 */

const average = list => list.reduce((x, y) => x + y) / list.length;

const nToFreq = d3.scalePow()
  .exponent(2)
  .domain([0, NUM_BARS])
  .range([MIN_FREQ, MAX_FREQ]);

const freqToBin = d3.scaleLinear()
  .domain([0, CONTEXT.sampleRate / 2])
  .range([0, FFT_SIZE / 2]);

const BIN_LOWER = Math.floor(freqToBin(MIN_FREQ));
const BIN_UPPER = Math.floor(freqToBin(MAX_FREQ));

// Use a power scale to group bins into equal pitch ranges
const nToBin = n => Math.floor(freqToBin(nToFreq(n)) - BIN_LOWER);

const aggregate = (data, num) => {
  return new Uint8Array(num).map((_, i) => {
    const lowerBound = Math.floor(nToBin(i));
    const upperBound = Math.floor(nToBin(i + 1));

    return average(data.slice(lowerBound, upperBound));
  });
};

/**
 * Vue
 */

const BarChart = {
  template: '#bar-chart',
  props: [
    'data',
    'width',
    'height',
  ],
  computed: {
    bars() {
      const len = this.data.length;

      const xScale = d3.scaleBand()
        .domain(d3.range(len))
        .rangeRound([0, this.width])
        .paddingInner(0.05);

      const yScale = d3.scaleLinear()
        .range([0, this.height])
        .domain([0, 255]); // TODO don't hardcode this value

      return Array.from(this.data).map((d, i) => {
        return {
          x: xScale(i),
          y: this.height - yScale(d),
          width: xScale.bandwidth(),
          height: yScale(d),
          fill: d3.interpolateRainbow(i / len),
        };
      });
    },
    viewBox() {
      return `0 0 ${this.width} ${this.height}`;
    },
  }
};

/**
 * Audio
 */

const analyser = CONTEXT.createAnalyser();

analyser.fftSize = FFT_SIZE;

const dataArray = new Uint8Array(analyser.frequencyBinCount);

const microphone = Rx.Observable.of(navigator)
  .flatMap(nav => nav.mediaDevices.getUserMedia({ audio: true, video: false }));

const mediaStream = microphone.map(stream => CONTEXT.createMediaStreamSource(stream))
  .do(source => source.connect(analyser));

const animationFrame = Rx.Observable.interval(0, Rx.Scheduler.animationFrame);

const frequencyData = animationFrame.withLatestFrom(mediaStream).map(([frame, source]) => {
  analyser.getByteFrequencyData(dataArray);

  return aggregate(dataArray.slice(BIN_LOWER, BIN_UPPER), NUM_BARS);
});

/**
 * App
 */

const vm = new Vue({
  el: '#app',
  data: {
    frequencies: [],
  },
  components: {
    'bar-chart': BarChart,
  },
});

frequencyData.subscribe(data => {
  vm.frequencies = data;
}, err => console.warn(err.message));

function resumeAudioContext() {
  CONTEXT.resume().then(() => {
    document.removeEventListener('click', resumeAudioContext);
  });
}

document.addEventListener('click', resumeAudioContext);</code></pre>

      </div>
      <script async src="/js/prism.js"></script>
      <script async src="https://static.codepen.io/assets/embed/ei.js"></script>
      <script>
      // Loop over all elements with the 'data-prefill' attribute
      Array.from(document.querySelectorAll('[data-prefill]'), (el) => {
        // Create a Click to Run button
        const button = document.createElement('button');
        button.innerHTML = 'Click to Run';
        button.setAttribute('class', 'prefill-click-to-run');
        button.classList.add('bg-transparent', 'border', 'border-primary', 'border-solid', 'hover:bg-primary', 'hover:text-white', 'p-2', 'text-primary', 'w-full');
        el.appendChild(button);

        // On click, the element will become the embed!
        button.addEventListener('click', () => {
          el.classList.add('codepen'); // Add the codepen class back.
          window.__CPEmbed(); // Trigger the CodePen embed script to run again.
        });
      });
      </script>
    

  </div>
</article>

  </main>

  <footer class="mb-6" role="contentinfo">
    <hr>

    <p>The online home of Steve Cherry</p>

    <ul class="list-none pl-0 flex">
      <li><a href="/feed.xml" class="hover:text-rss focus:text-rss">Feed</a></li>
      <li class="ml-3"><a href="mailto:stevenccherry@gmail.com">Email</a></li><li class="ml-3"><a href="https://github.com/sccherry" class="hover:text-github focus:text-github">Github</a></li><li class="ml-3"><a href="https://codepen.io/sccherry" class="hover:text-codepen focus:text-codepen">Codepen</a></li></ul>
  </footer>

  <script src="/js/pjax.js" defer></script>
  <script src="/js/main.js" defer></script>
</body>
</html>
